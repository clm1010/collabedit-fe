---
name: 部署与WS代理方案
overview: 基于现有前端 VITE_WS_URL=/ws 和中间件 WebSocket 路径，实现 192.168.20.174 的 Nginx 静态资源托管 + /ws 代理到 192.168.20.179:3001，不改动现有功能。
todos:
  - id: frontend-build
    content: 构建前端并同步 dist 到 174:/data/jiuyuan/dist
    status: completed
  - id: nginx-merge
    content: 合并 Nginx 静态目录与 /ws 反代配置
    status: completed
  - id: verify
    content: 验证页面与 WebSocket 连接
    status: in_progress
---

# 部署与WS代理方案

## 关键结论

- 前端会把 `VITE_WS_URL=/ws` 解析为 `ws(s)://当前域名/ws`，并自动追加 `/collaboration` 或 `/markdown`，最终连接为 `ws(s)://{前端域名}/ws/collaboration` 或 `.../ws/markdown`。
- 中间件实际 WebSocket 路径为 `/collaboration` 和 `/markdown`，因此 Nginx 只需将 `/ws/collaboration`、`/ws/markdown` 反代到 `192.168.20.179:3001` 即可。

## 计划步骤

1. **前端构建与分发**

- 在 `E:/job-project/collabedit-fe` 执行 `pnpm build:prod`，生成 `dist`。
- 将 `dist` 上传/同步到 `192.168.20.174:/data/jiuyuan/` 作为静态资源目录。

2. **Nginx 配置合并（保留现有配置，仅新增）**

- 在 `192.168.20.174` 的 Nginx 主配置目录（根据截图为 `/usr/local/nginx/conf`）内，保持现有 server 块与配置不变，只新增或合并以下内容：
- 静态资源根目录指向 `/data/jiuyuan/dist`。
- 新增 WebSocket 反代：`/ws/collaboration` 和 `/ws/markdown`。
- 参考仓库现成配置片段（[e:/job-project/collabedit-fe/nginx.conf](e:/job-project/collabedit-fe/nginx.conf)）。

3. **反代目标与安全检查**

- 反代目标地址固定为 `192.168.20.179:3001`（中间件 docker 已启动）。
- 确保 174 可访问 179 的 3001 端口；若有防火墙/安全组，放通 3001（仅内网可访问即可）。

4. **验证与回滚准备**

- 验证静态站点可访问，协同编辑能建立 WS 连接。
- Nginx 配置改动前备份原 `nginx.conf`，若重载失败可快速恢复。

## 关键代码依据

- 前端 WS 组装逻辑（相对路径 `/ws` + 追加 `/collaboration` 或 `/markdown`）：
- [e:/job-project/collabedit-fe/src/lmHooks/useEditorConfig.ts](e:/job-project/collabedit-fe/src/lmHooks/useEditorConfig.ts)
- [e:/job-project/collabedit-fe/src/views/training/document/config/editorConfig.ts](e:/job-project/collabedit-fe/src/views/training/document/config/editorConfig.ts)
- 中间件 WebSocket 路径：`/collaboration`、`/markdown`：
- [e:/job-project/collaborative-middleware/src/collaboration/collaboration.gateway.ts](e:/job-project/collaborative-middleware/src/collaboration/collaboration.gateway.ts)
- [e:/job-project/collaborative-middleware/src/markdown-collaboration/markdown-collaboration.gateway.ts](e:/job-project/collaborative-middleware/src/markdown-collaboration/markdown-collaboration.gateway.ts)

## 实施待办

- frontend-build: 产物构建并同步到 174 的 `/data/jiuyuan/dist`
- nginx-merge: 合并新增静态目录与 `/ws` 反代配置
- verify: 验证页面与 WS 连接正常