---
name: 协同编辑问题分析
overview: 分析 collabedit-fe 和 collaborative-middleware 项目中可能导致跨设备协同编辑问题和光标显示问题的代码逻辑。
todos:
  - id: verify-connection-kick
    content: 验证用户连接踢出逻辑是否是根本原因（查看服务器日志）
    status: pending
  - id: fix-user-connection-key
    content: 修改 collaboration.gateway.ts 中 userConnections 的 key 策略，支持同用户多设备连接
    status: pending
  - id: check-nginx-config
    content: 检查 Nginx 配置和网络可达性
    status: pending
  - id: add-awareness-retry
    content: 可选：在 useCollaboration.ts 中增加 awareness 状态更新的重试逻辑
    status: pending
  - id: todo-1768542664668-sbf53uvzb
    content: ''
    status: pending
---

# 跨设备协同编辑问题分析报告

## 问题概述

用户反馈的两个问题：

1. 跨设备无法协同编辑
2. 跨设备进入编辑器后，在线用户列表显示正常，但看不到自己的光标

## 问题一：跨设备无法协同编辑

### 可能原因 1：用户连接被踢出（中等可能性）

**位置**: [collaboration.gateway.ts](e:\job-project\collaborative-middleware\src\collaboration\collaboration.gateway.ts) 第 235-250 行

```typescript
// 检查同一用户是否已有连接（踢掉旧连接）
const userKey = `${docName}:${userInfo.id}`
const existingConnection = this.userConnections.get(userKey)
if (existingConnection && existingConnection !== client) {
  this.logger.warn(`⚠️ 用户 ${userInfo.name} 重复连接，踢掉旧连接`)
  this.cleanupConnection(existingConnection)
  // ...
}
```

**问题分析**:

- 如果同一用户（相同 userId）从不同设备连接到同一文档，后来的连接会踢掉之前的连接
- 这在以下场景会导致问题：
  - 用户登录同一账户，在不同设备打开同一文档
  - 用户复制了包含 userId 参数的 URL 到另一设备

**影响**: 如果用户的 userId 相同，只能有一个设备保持连接

---

### 可能原因 2：userId 生成机制（低可能性）

**位置**: [collaborationUser.ts](e:\job-project\collabedit-fe\src\store\modules\collaborationUser.ts) 第 26-36 行

```typescript
const loadUserFromStorage = (): CollaborationUserVO | null => {
  try {
    const stored = sessionStorage.getItem(STORAGE_KEY)
    if (stored) {
      return JSON.parse(stored) as CollaborationUserVO
    }
  } catch (e) {
    /* ... */
  }
  return null
}
```

**问题分析**:

- 使用 `sessionStorage` 存储用户信息
- `sessionStorage` 在同一浏览器的不同标签页间共享（某些情况下）
- 跨设备时，由于 `sessionStorage` 是独立的，会创建新的 userId（使用 `nanoid()`）
- 这实际上是正确的行为，跨设备 userId 应该不同

**结论**: userId 生成机制应该不会导致跨设备问题，除非有外部因素（如 URL 中固定了 userId）

---

### 可能原因 3：WebSocket 连接路径问题（高可能性）

**位置**: [editorConfig.ts](e:\job-project\collabedit-fe\src\views\training\document\config\editorConfig.ts) 第 25-39 行

```typescript
const resolveWsUrl = () => {
  const envUrl = (import.meta.env.VITE_WS_URL as string | undefined) || 'ws://localhost:3001'

  // 如果是相对路径，根据当前页面 host 动态构建完整 URL
  if (envUrl.startsWith('/') && !envUrl.startsWith('//')) {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
    const host = window.location.host
    const basePath = envUrl.replace(/\/+$/, '')
    return `${protocol}//${host}${basePath}/collaboration`
  }
  // ...
}
```

**问题分析**:

- 生产环境配置 `VITE_WS_URL=/ws`，前端会根据当前页面 host 动态构建 WebSocket URL
- 如果 Nginx 配置不正确，跨设备访问时 WebSocket 连接可能失败

**需要检查**:

- Nginx 配置中 `ws_middleware` 的 upstream 地址是否正确
- 跨设备访问时网络是否可达

---

### 可能原因 4：Nginx WebSocket 代理配置（高可能性）

**位置**: [nginx.conf](e:\job-project\collabedit-fe\nginx.conf) 第 59-71 行

```nginx
location /ws/collaboration {
    proxy_pass http://ws_middleware/collaboration;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    # ...
}
```

**潜在问题**:

- `upstream ws_middleware` 配置的是 `192.168.8.104:3001`
- 如果协同中间件运行在不同的服务器上，或者 IP 地址变化，会导致连接失败
- 缺少 `X-Forwarded-Host` 头，可能导致某些场景下的连接问题

---

## 问题二：看不到自己的光标

### 原因分析：这是 Y.js 和 Tiptap 的预期行为

**位置**: [TiptapEditor.vue](e:\job-project\collabedit-fe\src\views\training\document\components\TiptapEditor.vue) 第 420-426 行

```typescript
CollaborationCaret.configure({
  provider: props.provider,
  user: {
    name: props.user.name,
    color: props.user.color
  }
})
```

**解释**:

- `CollaborationCaret` 扩展（Tiptap v3 中称为 `collaboration-carets`）只渲染**其他用户**的光标
- 用户自己的光标由浏览器原生输入光标显示
- 这是协同编辑的标准行为，不是 bug

### 在线用户列表中应该能看到自己

**位置**: [useCollaboration.ts](e:\job-project\collabedit-fe\src\lmHooks\useCollaboration.ts) 第 149-166 行

```typescript
states.forEach((state: any, clientId: number) => {
  if (state.user) {
    const userId = state.user.id || `client_${clientId}`
    const isSelf = clientId === provider.value!.awareness.clientID

    if (isSelf || !userMap.has(userId)) {
      userMap.set(userId, {
        clientId,
        ...state.user,
        isSelf,
        isOwner: currentCreatorId !== undefined && state.user.id === currentCreatorId
      })
    }
  }
})
```

**代码分析**:

- `isSelf` 判断使用 `clientId === provider.value!.awareness.clientID`
- awareness 的 clientID 是 Y.js 自动分配的本地 clientID
- 如果协作者列表中看不到自己，可能是以下原因：
  1. awareness 状态尚未设置
  2. provider 连接尚未完成

---

## 建议的修复措施

### 修复 1：移除或改进用户连接踢出逻辑

在 `collaboration.gateway.ts` 中，考虑以下方案之一：

**方案 A**: 移除踢出逻辑，允许同一用户多设备连接

```typescript
// 删除第 235-250 行的踢出逻辑
```

**方案 B**: 使用 `userId + deviceId` 作为唯一标识

```typescript
const userKey = `${docName}:${userInfo.id}:${userInfo.deviceId}`
```

### 修复 2：确保 awareness 状态在连接建立后立即设置

在 `useCollaboration.ts` 的 `initCollaboration` 函数中，确保 awareness 状态设置成功：

```typescript
// 设置用户状态后，立即触发一次 awareness 更新
provider.value.awareness.setLocalStateField('user', userState)

// 强制触发一次本地状态更新
setTimeout(() => {
  updateCollaborators()
}, 200)
```

### 修复 3：检查 Nginx 配置

确保以下配置正确：

- `upstream ws_middleware` 指向正确的协同中间件地址
- 添加 `X-Forwarded-Host` 头
- 检查防火墙规则是否允许 WebSocket 连接

---

## 需要进一步确认的信息

1. 用户是否使用相同的账户登录到不同设备？
2. 跨设备访问时，浏览器控制台是否有 WebSocket 连接错误？
3. 协同中间件的日志中是否有"踢掉旧连接"的警告？
4. 用户期望看到的是编辑器中的光标还是协作面板中的用户列表？

---

## 总结

| 问题 | 可能原因 | 建议操作 |

|------|----------|----------|

| 跨设备无法协同编辑 | 同一 userId 导致连接被踢出 | 修改 userConnections 的 key 策略 |

| 跨设备无法协同编辑 | Nginx 代理配置问题 | 检查 upstream 地址和网络可达性 |

| 看不到自己的光标 | Tiptap 预期行为 | 无需修复（这是正常的） |

| 协作面板看不到自己 | awareness 状态未及时更新 | 增加重试逻辑或延迟更新 |
