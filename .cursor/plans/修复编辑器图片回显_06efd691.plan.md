---
name: 修复编辑器图片回显
overview: 修复演训方案编辑器中 data:image 报错、atob 解码失败和图片回显丢失问题，重点在加载回显与保存时的图片 base64 规范化与容错。
todos:
  - id: scan-image-flow
    content: 梳理加载/保存链路的图片处理点
    status: pending
  - id: normalize-base64
    content: 抽取并复用 base64 清理逻辑
    status: pending
  - id: fix-save-and-load
    content: 保存与回显处接入清理/容错
    status: pending
isProject: false
---

# 修复编辑器图片回显问题

## 现状与问题定位

- 回显与导入阶段已有 `validateAndFixImages` 清理逻辑，但**加载回显/保存**链路未统一使用，导致 `data:image` 里的空白/非法字符引发 `ERR_INVALID_URL` 与 `InvalidCharacterError`。
- `docModelToDocx` 的 `loadImageData` 直接 `atob`，遇到非法 base64 直接抛错，保存中断。
- 预加载内容进入编辑器前未清理图片，导致编辑器渲染阶段出现 `data:image` 报错。

相关代码：

```459:520:e:\job-project\collabedit-fe\src\views\training\document\utils\wordParser.shared.ts
export const validateAndFixImages = (html: string): string => {
  // ...
  return html.replace(
    /<img([^>]*)src=(["])data:image\/([^;]+);base64,([^"']*)\2([^>]*)>/gi,
    (_match, before, quote, type, base64Data, after) => {
      const cleanBase64 = normalizeBase64(base64Data)
      return `<img${before}src=${quote}data:image/${type};base64,${cleanBase64}${quote}${after}>`
    }
  )
}
```

```180:209:e:\job-project\collabedit-fe\src\views\training\document\utils\docModel\docModelToDocx.ts
const loadImageData = async (
  src: string
): Promise<{ data: Uint8Array; type: 'png' | 'jpg' | 'gif' | 'bmp' } | null> => {
  const base64Match = src.match(/^data:image\/(png|jpeg|jpg|gif|bmp);base64,(.+)$/)
  if (base64Match) {
    const base64Data = base64Match[2]
    const binary = atob(base64Data)
    // ...
  }
  // ...
}
```

## 方案

1. **统一 base64 清理逻辑**
  - 在 `wordParser.shared.ts` 中抽出可复用的 `normalizeBase64`/`normalizeDataImageSrc`（或复用已有 `validateAndFixImages` 的规范化逻辑）。
  - 让 `imageStore.ts` 与 `docModelToDocx.ts` 使用同一套清理逻辑，减少重复与差异。
2. **保存阶段容错**
  - 在 `docModelToDocx.ts` 的 `loadImageData` 中对 data URL 的 base64 做清理，再 `atob`。
  - 为 `atob` 添加 try/catch：遇到非法 base64 时记录 warning 并返回 `null`，避免整个保存流程失败。
3. **回显阶段清理**
  - 在 `parseFileContent`（`wordParser.pipeline.ts`）或 `TiptapCollaborativeEditor.vue` 的 `applyPreloadedContent` 前，对 HTML 执行 `validateAndFixImages`，确保 `data:image` 不含空白/非法字符。
  - 保持对非 HTML 内容的兼容：仅在包含 `<img` 或 `data:image` 时清理。
4. **验证与回归**
  - 用你的复现路径（导入 docx → 进入编辑器 → 保存 → 重新进入）验证：
    - 控制台不再出现 `ERR_INVALID_URL` / `InvalidCharacterError`。
    - 图片可正常显示与回显。

## 涉及文件

- [e:\job-project\collabedit-fe\src\views\training\document\utils\wordParser.shared.ts](e:\job-project\collabedit-fe\src\views\training\document\utils\wordParser.shared.ts)
- [e:\job-project\collabedit-fe\src\views\training\document\utils\docModel\docModelToDocx.ts](e:\job-project\collabedit-fe\src\views\training\document\utils\docModel\docModelToDocx.ts)
- [e:\job-project\collabedit-fe\src\views\training\document\utils\imageStore.ts](e:\job-project\collabedit-fe\src\views\training\document\utils\imageStore.ts)
- [e:\job-project\collabedit-fe\src\views\training\document\utils\wordParser.pipeline.ts](e:\job-project\collabedit-fe\src\views\training\document\utils\wordParser.pipeline.ts)
- [e:\job-project\collabedit-fe\src\views\training\document\TiptapCollaborativeEditor.vue](e:\job-project\collabedit-fe\src\views\training\document\TiptapCollaborativeEditor.vue)

## 说明

- 这套改动优先确保**保存不崩**与**回显可用**，同时减少 data URL 造成的浏览器错误。
- 若你希望进一步减少数据量，可在后续迭代再考虑把 `data:image` 统一替换成可持久化的文件 URL。

