---
name: 修复base64数据被正则破坏
overview: convertInlineStylesToTiptap 中的 pt->px 全局正则（第 97 行）会破坏 base64 图片数据中的 `数字+pt` 序列，导致图片在解析时 atob 失败。修复方案：在执行正则替换前保护 base64 数据区域，替换后还原。该函数被 5 个解析路径调用，修改一处即覆盖全部。
todos:
  - id: fix-postprocess
    content: 'wordParser.postprocess.ts: convertInlineStylesToTiptap + cleanWordHtml 增加 base64 保护/还原机制'
    status: completed
isProject: false
---

# 修复 base64 图片数据被 pt->px 正则破坏

## 根因

`[wordParser.postprocess.ts](src/views/training/document/utils/wordParser.postprocess.ts)` 第 97 行：

```typescript
html = html.replace(/(\d+(?:\.\d+)?)\s*pt/gi, (_, size) => `${ptToPx(parseFloat(size))}px`)
```

这个正则在**整个 HTML 字符串**上全局替换 "数字+pt" 为 "数字+px"。但 `<img src="data:image/png;base64,...">` 中的 base64 数据含有大量 `5pT`、`9Pt`、`12pt` 序列（base64 字符集 A-Z a-z 0-9 + / =）。正则匹配后引入非法字符 `.` 和 `x`，破坏 base64 完整性，导致 `atob` 失败。

## 影响范围

`convertInlineStylesToTiptap` 被 5 个解析路径调用：

- `wordParser.pipeline.ts` 第 137 行 (DocModel 策略)
- `wordParser.mammoth.ts` 第 164 行 (Mammoth 策略)
- `wordParser.ooxml.ts` 第 1247 行 (OOXML-enhanced 策略)
- `wordParser.preview.ts` 第 229 行 (docx-preview 策略)
- Mammoth 内部通过 `cleanWordHtml` 间接调用

**修改 `convertInlineStylesToTiptap` 一处即覆盖所有路径。**

## 精确审查结论

逐行审查 `convertInlineStylesToTiptap` 全部 190+ 行正则：

- **第 97 行**: 唯一的破坏点 -- `(\d+(?:\.\d+)?)\s*pt` 无 CSS 属性名前缀，会匹配 base64 中的内容
- 其他所有正则均有 `font-size:`、`color:`、`background-color:` 等 CSS 属性名前缀限定，不会匹配 base64 数据

`cleanWordHtml` 也逐行审查：所有正则安全，不影响 base64。

## 修复方案

在 `convertInlineStylesToTiptap` 函数开头保护 base64 数据，函数末尾还原：

```typescript
export const convertInlineStylesToTiptap = (html: string): string => {
  // 保护 base64 数据：提取所有 data:...;base64,... 内容，用占位符替代
  const base64Chunks: string[] = []
  html = html.replace(
    /(src=["'])data:([^;]+);base64,([^"']*)(["'])/gi,
    (_match, prefix, mime, base64, suffix) => {
      const idx = base64Chunks.length
      base64Chunks.push(`${prefix}data:${mime};base64,${base64}${suffix}`)
      return `__BASE64_PLACEHOLDER_${idx}__`
    }
  )

  // ... 原有的所有正则替换逻辑不变 ...

  // 还原 base64 数据
  if (base64Chunks.length > 0) {
    html = html.replace(/__BASE64_PLACEHOLDER_(\d+)__/g, (_, idx) => base64Chunks[parseInt(idx)])
  }

  return html
}
```

同时对 `cleanWordHtml` 也做同样的保护（虽然审查后确认当前安全，但作为防御性措施防止未来新增正则引入同类问题）。

## 涉及文件

仅 1 个文件：`[src/views/training/document/utils/wordParser.postprocess.ts](src/views/training/document/utils/wordParser.postprocess.ts)`

中间件无需修改。

## 影响评估

- `convertInlineStylesToTiptap` 的 CSS 样式转换逻辑**完全不受影响**（占位符不含任何 CSS 关键字）
- 占位符格式 `__BASE64_PLACEHOLDER_N__` 不会被任何现有正则匹配
- 性能影响可忽略：只在 HTML 含 `data:...;base64` 时才执行保护/还原
- 覆盖所有 5 个解析路径（因为都调用同一个函数）
