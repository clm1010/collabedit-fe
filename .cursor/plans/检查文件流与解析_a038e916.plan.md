---
name: 检查文件流与解析
overview: 端到端核查后端文件流是否完整、前端是否在解析/缓存中截断，定位导致“半张图”的真实环节。
todos:
  - id: locate-backend-stream
    content: 定位后端 DOCX 下载路由与 MinIO 读取逻辑
    status: pending
  - id: verify-backend-integrity
    content: 对比后端返回与 MinIO 原文件大小/哈希
    status: pending
  - id: trace-frontend-parsing
    content: 梳理前端流转换、缓存与解析链路
    status: pending
  - id: compare-end-to-end
    content: 对比不同来源文件与解析结果
    status: pending
isProject: false
---

# 端到端文件流排查计划

## 目标

确认后端返回的 DOCX 文件流是否完整，前端解析与缓存是否有截断或错误转换，最终导致图片显示不完整。

## 检查范围与关键点

- 后端文件流获取路径（路由/服务/MinIO 下载）
- 响应头与流式传输是否正确（Content-Length、Content-Type、流关闭时机）
- 前端下载与 base64/ArrayBuffer 转换、缓存与重新进入的回放路径

## 实施步骤

1. **定位后端文件流接口与实现**
  - 查找 `collabedit-node-backend` 中提供 DOCX 下载的路由与服务（如 `src/routes/*`、`src/services/file.service.ts` 或 MinIO 相关逻辑）。
  - 关注是否有 `Buffer` 拼接、流读写、`res.end()` 时机、或中间压缩/解压流程。
2. **校验后端返回是否完整**
  - 对比后端返回的文件流与 MinIO 原文件（大小/哈希）。
  - 如有现成脚本或日志，补充输出：文件大小、hash（MD5/SHA256）。
3. **梳理前端下载与解析链路**
  - 追踪前端拿到文件流后如何转换为 base64/ArrayBuffer、如何传入 `parseFileContent`。
  - 关注缓存逻辑（`docStorage`）是否对大文件有截断或限制。
  - 文件路径优先关注：
    - `e:/job-project/collabedit-fe/src/views/utils/docStorage.ts`
    - `e:/job-project/collabedit-fe/src/views/training/document/utils/wordParser.pipeline.ts`
    - `e:/job-project/collabedit-fe/src/views/training/document/TiptapCollaborativeEditor.vue`
4. **复现实验与对比**
  - 若可运行：同一 DOCX 分别从 MinIO 直下与后端接口下载，比较二进制一致性。
  - 将对比结果与前端解析后的 `data:image` 尺寸/长度做关联。
5. **输出结论与修复建议**
  - 若后端文件流完整：重点修复前端解析/缓存。
  - 若后端不完整：修复后端流式响应与下载逻辑。

