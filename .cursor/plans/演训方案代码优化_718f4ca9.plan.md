---
name: 演训方案代码优化
overview: 对演训方案和模板管理模块进行内存泄漏检查、代码优化和Bug修复。主要问题是 Yjs 协作逻辑存在大量重复代码，需要重构以使用现有的 `useCollaboration` hook，同时修复一些小的潜在问题。
todos:
  - id: refactor-tiptap-collaborative
    content: 重构 TiptapCollaborativeEditor.vue，使用 useCollaboration hook 替代重复的 Yjs 管理代码
    status: completed
  - id: refactor-markdown-collaborative
    content: 重构 MarkdownCollaborativeEditor.vue，使用 useCollaboration hook 替代重复的 Yjs 管理代码
    status: completed
  - id: extract-file-utils
    content: 提取 blobToBase64 等公共工具函数到 src/views/utils/fileUtils.ts
    status: completed
  - id: enhance-collaboration-hook
    content: （可选）增强 useCollaboration hook，添加 reinitialize 方法支持动态切换文档
    status: completed
isProject: false
---

# 演训方案和模板管理模块代码优化计划

## 核心发现

### 1. 主要问题：Yjs 协作代码重复（高优先级）

`[TiptapCollaborativeEditor.vue](e:\job-project\collabedit-fe\src\views\training\document\TiptapCollaborativeEditor.vue)` 和 `[MarkdownCollaborativeEditor.vue](e:\job-project\collabedit-fe\src\views\template\editor\MarkdownCollaborativeEditor.vue)` 直接管理 Yjs `ydoc` 和 `provider` 实例，包含约 150+ 行重复的初始化和清理逻辑。这些逻辑与 `[useCollaboration.ts](e:\job-project\collabedit-fe\src\lmHooks\useCollaboration.ts)` hook 几乎完全相同。

**问题示例（两个组件都有类似代码）**：

```typescript
let ydoc: Y.Doc | null = null
let provider: WebsocketProvider | null = null
let syncTimeoutId: ReturnType<typeof setTimeout> | null = null
let updateCollaboratorsTimer: ReturnType<typeof setTimeout> | null = null
let isComponentDestroyed = false
// ... 重复的 initCollaboration, updateCollaborators, cleanup 逻辑
```

### 2. 良好实践（无需修改）

以下文件的内存管理已经正确实现：

- `[useCollaboration.ts](e:\job-project\collabedit-fe\src\lmHooks\useCollaboration.ts)` - 完善的清理逻辑
- `[TiptapEditor.vue](e:\job-project\collabedit-fe\src\views\training\document\components\TiptapEditor.vue)` - 编辑器销毁正确
- `[MarkdownEditor.vue](e:\job-project\collabedit-fe\src\views\template\editor\components\MarkdownEditor.vue)` - 编辑器销毁正确
- `[docStorage.ts](e:\job-project\collabedit-fe\src\views\utils\docStorage.ts)` - IndexedDB 连接正确关闭
- `[wordParser.ts](e:\job-project\collabedit-fe\src\views\training\document\utils\wordParser.ts)` - Web Worker 正确终止

### 3. 次要问题

- `blobToBase64` 函数在多个文件中重复定义
- 部分 TypeScript 类型使用 `any`

---

## 优化方案

### 任务 1：重构 TiptapCollaborativeEditor.vue 使用 useCollaboration hook

**目标**：移除重复的 Yjs 管理代码，改用 `useCollaboration` hook

**修改要点**：

- 引入 `useCollaboration` hook
- 使用 hook 返回的 `ydoc`, `provider`, `collaborators`, `connectionStatus`, `isReady`
- 移除组件内的 `initCollaboration`, `updateCollaborators`, 清理逻辑
- 调整 `documentId` 的 watch 使用 hook 的 `cleanup` 和 `initCollaboration`

### 任务 2：重构 MarkdownCollaborativeEditor.vue 使用 useCollaboration hook

**目标**：与任务 1 相同，移除重复代码

**修改要点**：

- 引入 `useCollaboration` hook
- 替换本地 Yjs 管理逻辑
- 保留组件特有的业务逻辑（Markdown 转换、自定义元素等）

### 任务 3：提取公共工具函数

**目标**：将 `blobToBase64` 等重复函数提取到公共工具文件

**新建文件**：`src/views/utils/fileUtils.ts`

```typescript
export const blobToBase64 = (blob: Blob): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    reader.onload = () => resolve(reader.result as string)
    reader.onerror = (error) => reject(error)
    reader.readAsDataURL(blob)
  })
}
```

**修改文件**：

- `[performance/index.vue](e:\job-project\collabedit-fe\src\views\training\performance\index.vue)`
- `[template/management/index.vue](e:\job-project\collabedit-fe\src\views\template\management\index.vue)`

### 任务 4：增强 useCollaboration hook（可选优化）

**目标**：支持动态 documentId 切换

为 hook 添加 `reinitialize(newDocId: string)` 方法，简化组件中的 watch 逻辑：

```typescript
const reinitialize = (newDocId: string) => {
  cleanup()
  options.documentId = newDocId
  initCollaboration()
}
```

---

## 风险评估

- **低风险**：所有修改都是重构现有逻辑，不改变功能行为
- **测试建议**：重构后需要测试协作编辑的连接、同步、断开重连功能

## 不需要修改的部分

以下模块经审查无内存泄漏或重大问题：

- `[htmlToDocx.ts](e:\job-project\collabedit-fe\src\views\utils\htmlToDocx.ts)` - 纯工具函数
- `[documentExport.ts](e:\job-project\collabedit-fe\src\views\utils\documentExport.ts)` - 纯工具函数
- `[useEditorConfig.ts](e:\job-project\collabedit-fe\src\lmHooks\useEditorConfig.ts)` - 配置 hook
- `[AuditFlowDialog](e:\job-project\collabedit-fe\src\lmComponents\AuditFlowDialog\index.vue)` - 状态管理正确
- `[CollaborationPanel.vue](e:\job-project\collabedit-fe\src\lmComponents\collaboration\CollaborationPanel.vue)` - 无状态管理
- `[DocumentPreviewDialog](e:\job-project\collabedit-fe\src\lmComponents\DocumentPreviewDialog\index.vue)` - 简单组件
