---
name: 修复类型不匹配问题
overview: 修复演训方案和模板管理保存文件时 `uploaderId` 类型不匹配的错误（Int 传给 String 字段），同时全面排查了所有已实现接口，确认无其他类型问题。
todos:
  - id: fix-training-uploaderid
    content: "training.ts: 将 auth.userId (number) 转为 String 后传给 uploadFile"
    status: pending
  - id: fix-template-uploaderid
    content: "template.ts: 同样将 auth.userId (number) 转为 String 后传给 uploadFile"
    status: pending
isProject: false
---

# 修复演训方案 / 模板管理接口类型不匹配问题

## 报错原因

终端错误：`Argument 'uploaderId': Invalid value provided. Expected String or Null, provided Int.`

调用链：

```
training.ts:153  uploadFile(file, (req as any).auth?.userId, ...)
                                   ^^^^^^^^^^^^^^^^^^^^^^^^
                                   number (来自 AuthPayload.userId)
      |
      v
file.service.ts:74  uploadFile(file, uploaderId?: string, ...)
      |                               ^^^^^^^^^^^^^^^^^
      v                               参数声明是 string
prisma FileObject.uploaderId  -->  String?  (DB 层是字符串)
```

`req.auth.userId` 是 `number` 类型（来自 JWT 解析），但 `FileObject.uploaderId` 在 Prisma schema 中是 `String?`，直接传入导致类型错误。

## 需要修复的文件（2 处调用）

### (1) [src/routes/training.ts](e:\job-project\collabedit-node-backend\src\routes\training.ts) 第 153 行

```typescript
// 改前
const record = await uploadFile(file, (req as any).auth?.userId, existingFileId)

// 改后：将 number 转为 string
const record = await uploadFile(file, (req as any).auth?.userId != null ? String((req as any).auth.userId) : undefined, existingFileId)
```

### (2) [src/routes/template.ts](e:\job-project\collabedit-node-backend\src\routes\template.ts) 第 143 行

同样的修复：

```typescript
// 改前
const record = await uploadFile(file, (req as any).auth?.userId, existingFileId)

// 改后
const record = await uploadFile(file, (req as any).auth?.userId != null ? String((req as any).auth.userId) : undefined, existingFileId)
```

## 全面排查结果（已确认无其他类型问题）

逐一排查了所有后端路由和服务，结论如下：

- `getPermissionCheck`（training + template）：**上轮已修复**，`Number(userId)` 转换正确
- `saveData` / `savaTemplate` / `editData`：前端 JSON body 类型与 Prisma schema 全部为 `String?`，类型一致
- `delData` / `delList`：传入的 `ids` 是字符串数组，类型正确
- `publishData`（training + template）：`id` 是 string，`visibleScope` 是 string/string[]，类型正确
- `getFileStream`（training + template）：`req.query.id` 用 `String()` 包裹，类型正确
- `getMaterial`：`planId` 用 `String(id)` 包裹，类型正确
- `getExerciseData`：所有字段为 string，类型正确
- `examRecord` 路由（submitReview / TemSubmit / examApply / examTem / getOpinion）：`examResult` 用 `Number()` 包裹，其余为 string，类型正确
- `system/user` 路由：`req.auth.userId` 是 number，`User.id` 是 Int，类型匹配
- `auth` 路由：`req.auth.userId` 是 number，`User.id` 是 Int，类型匹配
- `file.service.ts` 的 `uploaderId` 参数和 DB 字段是 `String?` -- 只有本次报错的 2 处调用传了 number

**结论：只有文件上传接口（saveFile）的 `uploaderId` 存在类型不匹配，其余接口均无问题。**