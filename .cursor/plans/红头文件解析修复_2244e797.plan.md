---
name: 红头文件解析修复
overview: 修复红头文件 DOCX 导入时的三个问题：开头空行过多、标题未居中、中间空行过多。通过增强 HTML 清理逻辑，确保 text-align 样式被正确保留，并压缩多余空段落。
todos:
  - id: enhance-cleanRedHeadHtml
    content: 增强 cleanRedHeadHtml 函数：更彻底清理开头空段落、压缩连续空行、保留 text-align
    status: pending
  - id: enhance-cleanWordHtml
    content: 增强 StartToolbar.vue 中的 cleanWordHtml 函数空段落清理逻辑
    status: pending
  - id: enhance-confirmWordImport
    content: 增强 confirmWordImport 函数中的开头空段落清理正则
    status: pending
  - id: test-redhead-import
    content: 测试红头文件导入效果，验证三个问题是否修复
    status: pending
---

# 红头文件 DOCX 解析排版修复方案

## 问题分析

根据图片对比，当前导入存在以下问题：

1. **开头空行过多**：文档内容没有从起始位置开始，前面有多余空行
2. **红头标题未居中**：原始 Word 中的居中标题（红色"关于关于春节放假安排的通知的通知"）在编辑器中未居中
3. **中间空行过多**：内容段落之间出现过多空行，与原始文档不符

## 根本原因

1. **空段落清理不彻底**：正则表达式 `(<p>\s*<\/p>)` 无法匹配带有 `style` 或 `class` 属性的空段落
2. **text-align 样式丢失**：在 HTML 清理过程中，`text-align: center` 样式可能被错误清除
3. **空行压缩逻辑不完善**：只压缩了连续空段落，但没有处理带属性的空段落

## 修改方案

### 文件 1: [wordParser.ts](src/views/training/document/utils/wordParser.ts)

修改 `cleanRedHeadHtml` 函数（约第 1473 行）：

- **增强开头空段落清理**：使用更宽松的正则匹配带有任意属性的空段落
- **保留 text-align 样式**：确保 center、right、justify 等对齐方式不丢失
- **压缩连续空段落**：处理带 style/class 属性的空段落

关键修改：

```typescript
// 1. 增强开头空段落清理 - 匹配带任意属性的空段落
html = html.replace(/^(\s*<p[^>]*>\s*(?:&nbsp;|\s|<br\s*\/?>)*\s*<\/p>\s*)+/gi, '')

// 2. 压缩连续空段落（包括带属性的）
html = html.replace(/(<p[^>]*>\s*(?:&nbsp;|\s|<br\s*\/?>)*\s*<\/p>\s*){2,}/gi, '<p><br></p>')
```

### 文件 2: [StartToolbar.vue](src/views/training/document/components/toolbar/StartToolbar.vue)

修改 `cleanWordHtml` 函数（约第 977 行）和 `confirmWordImport` 函数（约第 1401 行）：

- **同步增强空段落清理逻辑**
- **确保 text-align 在所有清理步骤中被保留**

### 详细修改点

#### 1. cleanRedHeadHtml 增强（wordParser.ts）

在函数末尾添加更强的清理逻辑：

```typescript
// 清理开头的空段落 - 增强版，匹配带任意属性的空段落
html = html.replace(/^(\s*<p[^>]*>\s*(?:&nbsp;|\s|<br\s*\/?>)*\s*<\/p>\s*)+/gi, '')

// 压缩连续的空段落（保留一个）- 增强版
html = html.replace(/(<p[^>]*>\s*(?:&nbsp;|\s|<br\s*\/?>)*\s*<\/p>\s*){2,}/gi, '<p><br></p>')

// 清理中间的多余空段落（超过2个连续的压缩为1个）
html = html.replace(/(<p[^>]*>\s*<br\s*\/?>\s*<\/p>\s*){3,}/gi, '<p><br></p>')
```

#### 2. 确保 text-align 保留（wordParser.ts）

在 `cleanRedHeadHtml` 中增强 text-align 保留逻辑，处理更多格式：

```typescript
// 增强 text-align 样式保留 - 支持更多格式变体
html = html.replace(/<(p|div|h[1-6]|span)([^>]*)style="([^"]*)"/gi, (match, tag, attrs, style) => {
  // 提取 text-align（支持大小写和不同空格格式）
  const textAlignMatch = style.match(/text-align\s*:\s*(left|center|right|justify)/i)
  // ... 保留逻辑
})
```

#### 3. confirmWordImport 增强（StartToolbar.vue）

```typescript
// 增强清理开头空段落的正则 - 匹配带任意属性的空段落
content = content.replace(/^(\s*<p[^>]*>\s*(?:&nbsp;|\s|<br\s*\/?>)*\s*<\/p>\s*)+/gi, '')
```

## 测试验证

修改后需要验证：

1. 导入红头文件后，内容从编辑器顶部开始，无前置空行
2. 红色标题保持居中显示
3. 段落之间无多余空行，与原始 Word 文档一致
4. 其他格式（颜色、红线、正文、右对齐的落款）保持正确

## 注意事项

- 所有修改仅影响 HTML 清理逻辑，不影响解析核心流程
- 保持向后兼容，不影响普通文档的导入