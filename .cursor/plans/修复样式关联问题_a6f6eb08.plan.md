---
name: 修复样式关联问题
overview: 修复 Word 文档导入后对齐方式丢失以及工具栏字体/字号选择器不能正确显示当前样式的问题。
todos:
  - id: fix-toolbar-style-update
    content: 修改 StartToolbar.vue 中的样式监听逻辑，使用 editor 事件监听选区变化
    status: completed
  - id: verify-text-align
    content: 验证并确保 Word 导入的对齐样式被正确解析和应用
    status: completed
isProject: false
---

# 修复 Word 导入样式关联问题

## 问题分析

从图片对比发现两个问题：

### 问题 1：对齐方式丢失

- Word 中标题居中，导入后变成左对齐
- **根本原因**：Tiptap TextAlign 扩展能正确解析 `style="text-align: center"`，但可能在 HTML 导入过程中丢失

### 问题 2：工具栏字体/字号不关联

- 工具栏的字体和字号选择器显示为空
- **根本原因**：[StartToolbar.vue](e:\job-project\collabedit-fe\src\views\training\document\components\toolbar\StartToolbar.vue) 第 556-570 行的 watch 逻辑监听的是 `editor` 对象变化，而不是选区变化

当前代码：

```javascript
watch(
  editor,
  (e) => {
    if (e) {
      const fontFamily = e.getAttributes('textStyle').fontFamily
      currentFontFamily.value = fontFamily || ''
      const fontSize = e.getAttributes('textStyle').fontSize
      currentFontSize.value = fontSize || ''
    }
  },
  { deep: true }
)
```

这个 watch 只在编辑器对象变化时触发，不会在用户移动光标或选择文本时更新。

## 解决方案

### 修复 1：工具栏样式监听

修改 [StartToolbar.vue](e:\job-project\collabedit-fe\src\views\training\document\components\toolbar\StartToolbar.vue) 中的样式监听逻辑：

1. 使用 `editor.on('selectionUpdate')` 或 `editor.on('transaction')` 事件监听选区变化
2. 在回调中获取当前选区的字体、字号、对齐等样式
3. 添加对文本颜色和背景色的监听

### 修复 2：验证并修复对齐方式解析

检查 Word 导入后的 HTML 是否包含正确的 text-align 样式：

1. 在 [wordParser.ts](e:\job-project\collabedit-fe\src\views\training\document\utils\wordParser.ts) 中确认对齐样式被正确生成
2. 确保 Tiptap 的 TextAlign 扩展配置了正确的 types

## 关键代码修改

### StartToolbar.vue 修改位置

- 第 556-570 行：替换 watch 为 editor 事件监听
- 添加 `updateCurrentStyles` 函数获取当前选区的所有样式
- 在 onMounted 和 editor 初始化后注册事件监听

### 预期修改内容

```javascript
// 更新当前样式的函数
const updateCurrentStyles = () => {
  if (!editor.value) return

  // 获取字体
  const fontFamily = editor.value.getAttributes('textStyle').fontFamily
  currentFontFamily.value = fontFamily || ''

  // 获取字号
  const fontSize = editor.value.getAttributes('textStyle').fontSize
  currentFontSize.value = fontSize || ''

  // 获取颜色
  const color = editor.value.getAttributes('textStyle').color
  if (color) textColor.value = color

  // 获取高亮色
  const highlight = editor.value.getAttributes('highlight').color
  if (highlight) highlightColor.value = highlight
}

// 监听编辑器初始化，注册事件
watch(
  editor,
  (e) => {
    if (e) {
      e.on('selectionUpdate', updateCurrentStyles)
      e.on('transaction', updateCurrentStyles)
      updateCurrentStyles() // 初始化时也调用一次
    }
  },
  { immediate: true }
)
```

## 不影响现有功能

- 保持现有的 `handleFontFamily`、`handleFontSize` 等设置样式的函数不变
- 只修改样式读取逻辑，不改变样式设置逻辑
- TextAlign 扩展配置保持不变
