---
name: 协同编辑优化配置
overview: 优化协同编辑系统的心跳检测、文档清理时间，并为演训方案和模板管理编辑器添加自动保存功能。
todos:
  - id: middleware-tiptap
    content: 修改 collaboration.gateway.ts：心跳 10秒，文档清理 2分钟
    status: completed
  - id: middleware-markdown
    content: 修改 markdown-collaboration.gateway.ts：心跳 10秒，文档清理 2分钟
    status: completed
  - id: autosave-tiptap
    content: TiptapCollaborativeEditor.vue 添加自动保存功能（防抖3秒）
    status: completed
  - id: autosave-markdown
    content: MarkdownCollaborativeEditor.vue 添加自动保存功能（防抖3秒）
    status: completed
  - id: test-verify
    content: 测试验证：心跳检测、离线判定、自动保存功能
    status: completed
isProject: false
---

# 协同编辑系统优化方案

## 修改目标

| 配置项 | 当前值 | 目标值 | 效果 |

|--------|--------|--------|------|

| 心跳间隔 | 30秒 | 10秒 | 更快检测离线用户 |

| 离线判定 | 30-60秒 | 10-20秒 | 自动随心跳调整 |

| 文档清理 | 5分钟 | 2分钟 | 更快释放内存，更快获取MinIO新内容 |

| 自动保存 | 无 | 防抖3秒 | 防止内容丢失 |

---

## 一、协同中间件配置修改

### 1.1 演训方案协同 (Tiptap/DOCX)

修改文件: `[collaborative-middleware/src/collaboration/collaboration.gateway.ts](e:\job-project\collaborative-middleware\src\collaboration\collaboration.gateway.ts)`

```typescript
// 修改心跳间隔：30秒 → 10秒
private readonly HEARTBEAT_INTERVAL = 10000

// 修改文档清理时间：5分钟 → 2分钟
}, 2 * 60 * 1000)
```

### 1.2 模板管理协同 (Markdown)

修改文件: `[collaborative-middleware/src/markdown-collaboration/markdown-collaboration.gateway.ts](e:\job-project\collaborative-middleware\src\markdown-collaboration\markdown-collaboration.gateway.ts)`

同样的修改：

- `HEARTBEAT_INTERVAL`: 30000 → 10000
- 文档清理定时器: `5 * 60 * 1000` → `2 * 60 * 1000`

---

## 二、前端自动保存功能

### 2.1 实现方案

采用**防抖保存**策略：用户停止编辑 3 秒后自动保存到 MinIO。

### 2.2 演训方案编辑器

修改文件: `[collabedit-fe/src/views/training/document/TiptapCollaborativeEditor.vue](e:\job-project\collabedit-fe\src\views\training\document\TiptapCollaborativeEditor.vue)`

添加内容：

- 自动保存定时器引用 `autoSaveTimer`
- 保存状态标记 `isAutoSaving`
- `setupAutoSave()` 函数：监听编辑器 `update` 事件
- 防抖逻辑：3秒无操作后触发保存
- 组件卸载时清理定时器

### 2.3 模板管理编辑器

修改文件: `[collabedit-fe/src/views/template/editor/MarkdownCollaborativeEditor.vue](e:\job-project\collabedit-fe\src\views\template\editor\MarkdownCollaborativeEditor.vue)`

同样的自动保存逻辑。

---

## 三、自动保存流程

```
用户输入 → 重置3秒定时器 → 用户停止输入 → 3秒后触发保存 → 调用 handleSave() → 显示保存状态
```

保存状态显示：

- 保存中：显示加载指示器
- 保存成功：显示"已自动保存"提示（轻量级，不打断用户）
- 保存失败：显示错误提示

---

## 四、注意事项

1. **首次加载不触发自动保存**：避免刚进入页面就保存空内容或初始内容
2. **内容无变化不保存**：检测内容是否真的变化，避免重复保存
3. **组件卸载时清理**：防止内存泄漏
4. **与手动保存共存**：自动保存不影响手动保存按钮功能
