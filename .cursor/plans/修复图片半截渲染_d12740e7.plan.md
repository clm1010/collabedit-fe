---
name: 修复图片半截渲染
overview: 定位演训方案文件流渲染时图片仅显示上半部的原因，优先覆盖渲染容器样式与图片节点尺寸逻辑，同时补充解析阶段的尺寸与样式校正，确保编辑器内完整显示。
todos:
  - id: inspect-render-css
    content: 确认图片容器与wrapper的裁剪风险点
    status: pending
  - id: fix-render-css
    content: 修复图片容器CSS与布局模式
    status: pending
  - id: stream-image-placeholders
    content: 增加图片占位与加载完成替换的流式展示
    status: pending
  - id: image-timeout-retry
    content: 增加图片软超时、状态提示与失败重试
    status: pending
  - id: fix-parse-height
    content: 修复解析阶段图片高度异常写入
    status: pending
  - id: verify-training-flow
    content: 在演训方案渲染流程中回归验证
    status: pending
isProject: false
---

# 修复编辑器图片半截渲染

## 目标范围

- 仅针对“演训方案进入编辑器 → 获取文件流解析并渲染”路径，确保所有图片完整显示。
- 兼顾渲染层 CSS 裁剪与解析层尺寸/样式数据一致性。
- 采用策略2：先显示编辑器框架/文本与图片占位，图片加载完成后替换为真实图片。
- 增加软超时、状态提示与失败重试，避免慢图阻塞整体体验。
- 默认阈值：软超时 10s（提示“加载较慢”）、失败判定 30s（提示“加载失败”）、重试间隔 3s，最多 2 次。

## 重点排查与改动位置

- 渲染层（图片容器与节点）
  - [E:/job-project/collabedit-fe/src/views/training/document/components/toolbar/extensions/ResizableImageComponent.vue](E:/job-project/collabedit-fe/src/views/training/document/components/toolbar/extensions/ResizableImageComponent.vue)
    - 检查/修复 `wrapper` 的 `line-height` 与 `display` 组合，避免行内渲染被裁剪。
    - 确保 `image-container` 和 `img` 的 `height`/`max-height`/`overflow` 与布局一致。
  - [E:/job-project/collabedit-fe/src/views/training/document/components/TiptapEditor.vue](E:/job-project/collabedit-fe/src/views/training/document/components/TiptapEditor.vue)
    - 调整 `.resizable-image-wrapper` 的 `display/line-height/vertical-align` 以避免半截渲染。
- 解析层（文件流 → HTML → DocModel → 图片属性）
  - [E:/job-project/collabedit-fe/src/views/training/document/utils/wordParser.pipeline.ts](E:/job-project/collabedit-fe/src/views/training/document/utils/wordParser.pipeline.ts)
    - 添加对解析结果中图片样式一致性的校验（宽高异常时重置高度）。
  - [E:/job-project/collabedit-fe/src/views/training/document/utils/wordParser.postprocess.ts](E:/job-project/collabedit-fe/src/views/training/document/utils/wordParser.postprocess.ts)
    - 强化对 `height` 异常值的修正，确保 `height:auto` 真实生效。
  - [E:/job-project/collabedit-fe/src/views/training/document/utils/docModel/htmlParser.ts](E:/job-project/collabedit-fe/src/views/training/document/utils/docModel/htmlParser.ts)
    - 解析图片 `width/height` 时增加防御：对非法/过小高度做清理，避免错误高度写入节点。

## 实施步骤

1. 渲染层修复

- 将 `.resizable-image-wrapper` 从 `inline-block` 调整为更安全的布局（例如 `inline-flex` 或 `flex`），并设置 `line-height: normal` / `0` 取决于验证结果，避免半截裁剪。
- 给图片容器与 `img` 明确 `height: auto` 与 `max-height: none`，并确保不被父级 `overflow: hidden` 裁切。

1. 流式展示（策略2）

- 编辑器先渲染文本与图片占位组件，图片加载完成后替换为真实图片并触发尺寸回写。
- 对未完成加载的图片标记状态，避免阻塞整文档显示。
- 设置软超时阈值（默认 10s）：超时后仍显示内容，但在图片位置提示“加载较慢”。
- 设置失败判定阈值（默认 30s）：提示“加载失败”，并显示重试入口。
- 重试策略：默认间隔 3s，最多 2 次；记录失败原因便于排查。

1. 解析层修复

- 在后处理阶段清理异常 `height`（如 0、极小值、非数值），统一重置为 `auto`。
- 在 `htmlParser` 中仅保留可信的 `width/height`，否则删除 `height`，让渲染端根据自然尺寸/宽度自适应。

1. 回归验证

- 在演训方案中加载同一份文件流，检查所有图片是否完整显示。
- 对比本地 MinIO 下载后的 docx 结果，确保编辑器中渲染不再被裁剪。

## 测试建议

- 选取包含多张不同尺寸图片的演训方案文档进行加载与滚动查看。
- 验证不同对齐方式（左/中/右）与不同缩放后的图片仍完整显示。
