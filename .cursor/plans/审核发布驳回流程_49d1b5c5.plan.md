---
name: 审核发布驳回流程
overview: 分析发现后端已实现基本的提交审核、发布、驳回接口，但存在参数处理不完整、路由重复、逻辑不一致等问题，需要进行修复和完善。
todos:
  - id: schema-update
    content: 修改 schema.prisma：ExamRecord 表新增 auditors 字段（Json 类型）
    status: completed
  - id: exam-service
    content: 修改 exam.service.ts：submitExam 函数增加 auditors 参数处理
    status: completed
  - id: examRecord-route
    content: 修改 examRecord.ts：两个提交审核路由增加 auditors 参数接收
    status: completed
  - id: remove-duplicate
    content: 修改 template.ts：移除重复的 /examRecord/TemSubmit 路由
    status: completed
  - id: template-publish
    content: 修改 template.service.ts：publishTemplate 增加 applyNode 更新和统一 visibleScope 处理
    status: completed
  - id: db-migrate
    content: 执行数据库迁移：npx prisma migrate dev
    status: completed
isProject: false
---

# 后端审核发布驳回流程修复计划

## 现状分析

### 已实现的接口


| 功能  | 接口路径 | 状态  |
| --- | ---- | --- |


后端已实现以下6个接口：

- `POST /examRecord/submitReview` - 提交演训审核
- `POST /examRecord/TemSubmit` - 提交模板审核
- `POST /examRecord/examApply` - 演训审核/驳回
- `POST /examRecord/examTem` - 模板审核/驳回
- `POST /getPlan/publishData` - 发布演训
- `POST /tbTemplate/publishData` - 发布模板

### 发现的问题

#### 问题1: 提交审核缺少 `auditors` 参数处理

前端期望的参数：

```typescript
interface SubmitAuditReqVO {
  id: string
  flowId: string
  auditors: Record<string, string[]> // 节点审核人 { node1: ['user1'], node2: ['user2'] }
  comment?: string
}
```

后端当前只处理了 `id`, `flowId`, `comment`，**忽略了 `auditors` 参数**。

相关代码位置：

- [examRecord.ts](e:\job-project\collabedit-node-backend\src\routes\examRecord.ts) 第10-22行
- [exam.service.ts](e:\job-project\collabedit-node-backend\src\services\exam.service.ts) 第6-47行

#### 问题2: 路由重复定义

`/examRecord/TemSubmit` 在两个文件中重复定义：

- [examRecord.ts](e:\job-project\collabedit-node-backend\src\routes\examRecord.ts) 第18行（正确实现）
- [template.ts](e:\job-project\collabedit-node-backend\src\routes\template.ts) 第66行（不完整实现，未更新 applyNode）

#### 问题3: 模板发布未更新 `applyNode`

演训发布时会更新 `applyNode: '4'`，但模板发布没有这个逻辑：

```typescript
// training.service.ts - 演训发布（正确）
data: { publishStatus: 'published', visibleScope: scope, applyNode: '4' }

// template.service.ts - 模板发布（缺少 applyNode）
data: { publishStatus: 'published', visibleScope: data.visibleScope ?? '' }
```

#### 问题4: visibleScope 处理不一致

- 演训：将数组 join 为字符串
- 模板：直接使用传入的值

---

## 修复方案

### 1. Schema 修改

在 `ExamRecord` 表中新增 `auditors` 字段存储审核人信息：

```prisma
model ExamRecord {
  // ... 现有字段
  auditors    Json?    @map("auditors")  // 新增：节点审核人 JSON
}
```

### 2. 修改提交审核服务

修改 [exam.service.ts](e:\job-project\collabedit-node-backend\src\services\exam.service.ts)：

- `submitExam` 函数增加 `auditors` 参数
- 将 auditors 存储到 ExamRecord 表

```typescript
export const submitExam = async (payload: {
  applyId: string
  applyType: 'training' | 'template'
  comment?: string
  flowId?: string
  auditors?: Record<string, string[]> // 新增
}) => {
  // ... 创建记录时包含 auditors
  const record = await tx.examRecord.create({
    data: {
      applyId,
      applyType,
      examResult: 0,
      examOpinion: comment ?? '',
      examNode: 'submit',
      auditors: auditors ?? null // 新增
    }
  })
}
```

### 3. 修改提交审核路由

修改 [examRecord.ts](e:\job-project\collabedit-node-backend\src\routes\examRecord.ts)：

```typescript
router.post('/examRecord/submitReview', async (req, res) => {
  const { id, comment, flowId, auditors } = req.body ?? {} // 增加 auditors
  if (!id) return fail(res, '缺少id', 400)
  const record = await submitExam({
    applyId: id,
    applyType: 'training',
    comment,
    flowId,
    auditors // 传递 auditors
  })
  return ok(res, record)
})
```

### 4. 移除重复路由

从 [template.ts](e:\job-project\collabedit-node-backend\src\routes\template.ts) 中移除第66-79行的 `/examRecord/TemSubmit` 路由，统一使用 `examRecord.ts` 中的实现。

### 5. 修复模板发布逻辑

修改 [template.service.ts](e:\job-project\collabedit-node-backend\src\services\template.service.ts)：

```typescript
export const publishTemplate = async (data: {
  id: string
  visibleScope?: string | string[] // 支持数组
}) => {
  const scope = Array.isArray(data.visibleScope)
    ? data.visibleScope.filter(Boolean).join(',')
    : (data.visibleScope ?? '')

  return prisma.template.update({
    where: { id: data.id },
    data: {
      publishStatus: 'published',
      visibleScope: scope,
      applyNode: '4' // 新增：与演训保持一致
    }
  })
}
```

---

## 修改文件清单

- `prisma/schema.prisma` - ExamRecord 新增 auditors 字段
- `src/services/exam.service.ts` - submitExam 增加 auditors 处理
- `src/routes/examRecord.ts` - 路由接收 auditors 参数
- `src/routes/template.ts` - 移除重复的 /examRecord/TemSubmit 路由
- `src/services/template.service.ts` - publishTemplate 增加 applyNode 和统一 visibleScope 处理

---

## 数据库迁移

修改 schema 后需要执行：

```bash
npx prisma migrate dev --name add_auditors_field
```

