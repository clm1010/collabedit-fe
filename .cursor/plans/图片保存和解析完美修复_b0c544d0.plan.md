---
name: 图片保存和解析完美修复
overview: 修复保存流程中图片数据丢失问题（handleSave 改用异步版图片恢复 + 增强 docModelToDocx 容错）；优化中间件 awareness 消息格式消除协作断开警告；评估 DOCX 解析兼容性并给出结论。
todos:
  - id: fix-save-async
    content: 'TiptapCollaborativeEditor.vue: handleSave 改用 restoreBlobImagesFromOriginAsync'
    status: completed
  - id: fix-save-log
    content: 'fileUtils.ts: 增强 restoreBlobImagesFromOriginAsync 错误日志'
    status: completed
  - id: fix-middleware-clock
    content: 'collaboration.gateway.ts: broadcastAwarenessRemove clock 值改用 0xFFFFFFFF'
    status: completed
  - id: fix-middleware-md
    content: 'markdown-collaboration.gateway.ts: 同步修改 clock 值'
    status: completed
isProject: false
---

# 图片保存和解析完美修复（终版方案）

## 修复范围检查

### 已有修复覆盖情况

| 修复方案 | 演训方案编辑器 | 模板管理编辑器 | 说明 |
| --- | --- | --- | --- |
| 协作内容重复修复 (plan 1) | 已修复 | 已修复 | 两个编辑器都已调整初始化时序 |
| 高优先级代码问题 (plan 2) | 已修复 | 不适用 | 模板编辑器保存为 .md 格式，不涉及 ImageStore/ResizableImage/blob URL |
| 本次图片保存修复 (plan 3) | **需要修复** | 不适用 | 只有演训方案编辑器保存为 DOCX |

### 模板编辑器为什么不需要修复

`MarkdownCollaborativeEditor.vue` 的保存流程（第 525-559 行）：

```typescript
const content = editorInstance.value.getHTML()
const blob = htmlToMarkdownBlob(content) // 转为 Markdown，不涉及图片 blob URL 处理
await saveMarkdownFile(documentId.value, blob, `${documentTitle.value}.md`)
```

- 保存为 `.md` 格式，不经过 `docModelToDocx`
- 不使用 `ImageStore`、`ResizableImage`、`data-origin-src`
- 不涉及 blob URL 到 data URL 的转换
- 协作内容重复问题已在 plan 1 中修复

## 本次修复内容

### 1. TiptapCollaborativeEditor.vue — handleSave 改用异步版

**问题**: `handleSave`（第 809 行）使用同步版 `restoreBlobImagesFromOrigin`，而同项目的 `ExportToolbar.vue`（导出功能）已经正确使用了异步版 `restoreBlobImagesFromOriginAsync`。这个不一致导致：保存时缺少 `data-origin-src` 的 blob URL 无法被 fetch 恢复，图片数据丢失。

**修改**:

- import 语句：`restoreBlobImagesFromOrigin` -> `restoreBlobImagesFromOriginAsync`
- handleSave 内部：`restoreBlobImagesFromOrigin(content)` -> `await restoreBlobImagesFromOriginAsync(content)`

**影响评估**: `handleSave` 本身已是 async 函数，改为 await 无架构影响。与 ExportToolbar 保持一致。

### 2. collaboration.gateway.ts — awareness clock 值优化

**问题**: `broadcastAwarenessRemove`（第 225 行）使用 `Date.now() % 0xFFFFFFFF` 作为 clock 值，可能小于客户端当前 clock，导致 y-prosemirror 解析异常（"Unexpected end of array"）。

**修改**: 将 `Date.now() % 0xFFFFFFFF` 改为 `0xFFFFFFFF`（最大值，确保覆盖任何旧状态）。

### 3. markdown-collaboration.gateway.ts — 同步修改

第 216 行同样的 clock 值问题，同步修改。

## 涉及文件（4 个）

### 前端

- `[src/views/training/document/TiptapCollaborativeEditor.vue](src/views/training/document/TiptapCollaborativeEditor.vue)` — handleSave 改异步版
- `[src/views/utils/fileUtils.ts](src/views/utils/fileUtils.ts)` — 增强 restoreBlobImagesFromOriginAsync 错误日志

### 中间件

- `[src/collaboration/collaboration.gateway.ts](collaborative-middleware/src/collaboration/collaboration.gateway.ts)` — clock 值
- `[src/markdown-collaboration/markdown-collaboration.gateway.ts](collaborative-middleware/src/markdown-collaboration/markdown-collaboration.gateway.ts)` — clock 值
