---
name: 重构方案评审反馈
overview: 对"演训方案编辑链路重构"计划进行全面评审，确认其合理性、指出遗漏项和风险点，并给出改进建议。
todos:
  - id: fix-plan-export-await
    content: 修正计划：ExportToolbar.vue 的 await 修复应覆盖全部 5 处调用，不仅仅是 exportPdf
    status: pending
  - id: fix-plan-start-toolbar
    content: 修正计划：Phase 2.1 补充 StartToolbar.vue 中的 normalizeCssColor 也需统一
    status: pending
  - id: fix-plan-logger-location
    content: 修正计划：logger 工具应独立文件，不要放在 fileUtils.ts 中
    status: pending
  - id: fix-plan-generateFullHtml-async
    content: 修正计划：generateFullHtml 统一为异步版本，所有调用方加 await，与 5.5 合并
    status: pending
  - id: evaluate-phase5-3
    content: 评估 Phase 5.3 em/rem/% 换算的实际需求，可能降低优先级
    status: pending
  - id: evaluate-phase5-2
    content: 评估 Phase 5.2 命名颜色补全的实际需求，建议按需补充而非全量
    status: pending
isProject: false
---

# 演训方案编辑链路重构 — 评审反馈

## 总体评价

方案整体**合理且结构清晰**。5 个 Phase 的分层设计从低风险到高风险递进，是正确的重构策略。现状分析准确抓住了核心问题，涉及文件清单完整。以下逐项给出具体评价和需要注意的地方。

---

## 已验证正确的部分

- **docStorage.ts 可安全删除** — 文件顶部已标注 `@deprecated`，且全项目零引用，已被 `docBuffer.ts` (Pinia Store) 完全替代
- **console 语句数量** — 实际统计基本吻合（performance/index.vue: 30条, TiptapCollaborativeEditor.vue: 32条, wordParser.pipeline.ts: 16条）
- **重复代码确认** — `normalizeCssColor` vs `normalizeColor`、`sanitizeImagesIfNeeded` 双份、`generateFullHtml` 双份均已验证存在
- **installDebugCollectors 全局 patch** — 确认存在且侵入性强，应移除
- **ExportToolbar.vue async bug** — 已确认存在
- **协同中间件无需修改** — 确认代码质量良好，使用 NestJS Logger

---

## 需要补充/修正的问题

### 1. ExportToolbar.vue 的 async bug 范围被低估

计划只提到 `exportPdf` 中缺少 `await`（第 274 行），但实际上**有 5 处**缺少 `await`：


| 函数              | 行号  | 问题                                        |
| --------------- | --- | ----------------------------------------- |
| `exportPdf`     | 274 | `const html = generateFullHtml()` 缺 await |
| `copyHtml`      | 307 | 同上                                        |
| `downloadHtml`  | 317 | 同上                                        |
| `printDocument` | 326 | 同上                                        |
| `printPreview`  | 346 | 同上                                        |


**建议：** Phase 5.5 应扩大修复范围，覆盖所有调用点。

### 2. 遗漏了 StartToolbar.vue 中的 `normalizeCssColor`

除了 `TiptapEditor.vue`（第 744 行），`StartToolbar.vue`（约第 789 行）中也有一份 `normalizeCssColor`。Phase 2.1 应将其纳入统一范围。

### 3. logger 放置位置不太合理

计划将 `logger` 放在 `fileUtils.ts` 中，但 `fileUtils.ts` 本身是文件操作工具，不是通用工具模块。

**建议：** 将 `logger` 提取为独立文件（如 `src/utils/logger.ts` 或 `src/views/utils/logger.ts`），保持职责单一。

### 4. `generateFullHtml` 统一方案需明确异步策略

当前两份 `generateFullHtml` 有本质差异：

- `TiptapEditor.vue` 中的是**同步**版本
- `ExportToolbar.vue` 中的是**异步**版本（需要 `await restoreBlobImagesFromOriginAsync`）

统一后应该是**异步**版本，所有调用方都需要加 `await`。这与 Phase 5.5 的修复有交叉，应合并考虑。

---

## 风险评估

### 高风险：Phase 3 — applyPreloadedContent 重写

- 当前 `applyPreloadedContent` 长达 177 行，包含 5 次重试、嵌套 setTimeout、与协同的竞态处理
- 重写后的简化版（计划中的伪代码）看起来清爽，但**缺少对以下边界场景的处理**：
  - 编辑器 DOM 未就绪时 `setContent` 失败的具体判断逻辑（`trySetContent` 的实现细节）
  - 样式恢复 fallback（当前代码中有专门处理样式丢失的逻辑）
  - 协同连接在内容应用过程中抢先 sync 的处理
- **建议：** 重写前先为当前逻辑补充关键路径的手动测试用例，确保重构后行为一致

### 中风险：Phase 5.3 — em/rem/% 单位换算

- DOCX 文件中字号通常以 `pt`（半点）或 `px` 为单位，很少出现 `em`/`rem`/`%`
- 这些相对单位的换算依赖上下文（父元素字号、根字号），静态换算可能产生错误结果
- **建议：** 先统计实际解析中是否出现过这些单位，如果极少出现可以降低优先级或仅做 `pt → px` 的换算

### 低风险但工作量大：Phase 5.2 — 补全 148 个 W3C 命名颜色

- DOCX 文件中的颜色通常以十六进制表示（如 `FF0000`），命名色出现频率很低
- 补全到 148 个会增加大量代码但收益有限
- **建议：** 保持当前 ~30 个常用色，仅在实际遇到解析失败时再逐步补充

---

## 建议的执行顺序调整

原计划 Phase 1-5 的顺序基本合理，但建议做以下微调：

1. **Phase 1**（清理）— 优先执行，风险最低，收益明显
2. **Phase 2**（去重）— 紧随其后，注意补充 `StartToolbar.vue` 中的 `normalizeCssColor`
3. **Phase 5.5**（修复 async bug）— **提前到 Phase 2 之后立即执行**，因为这是功能性 bug，影响导出/复制/打印
4. **Phase 3**（重构加载逻辑）— 需要最多测试，建议单独一个迭代
5. **Phase 4**（解析健壮性）— 与 Phase 3 可并行
6. **Phase 5.1-5.4**（格式优化）— 最后执行，优先级可根据实际需求调整

---

## 补充建议

- **缺少测试策略**：建议至少为 `applyPreloadedContent` 重写、`parseFileContent` 增强、`generateFullHtml` 统一这三个高影响变更准备回归测试方案
- **缺少回滚方案**：Phase 3 的 applyPreloadedContent 重写如果引入回归，应有快速回滚的 git 策略（建议每个 Phase 单独一个 commit）
- **docBuffer.ts 也在 git 变更列表中**（untracked）：确认其状态是否稳定，避免重构过程中与新增 store 产生冲突

